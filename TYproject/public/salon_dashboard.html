<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salon Dashboard - Snaplooks</title>
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-auth-compat.js"></script>

    <!-- Bootstrap CSS -->
    <link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css'>

    <!-- Bootstrap JS and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            display: flex;
        }

        #sidebar {
            width: 250px;
            background-color: #343a40;
            color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            height: 100vh; /* Adjust the height to cover the full viewport height */
            position: fixed; /* Fixed position to keep it on the screen while scrolling */
        }

        #mainContent {
            flex: 1;
            padding: 20px;
            margin-left: 250px; /* Adjust the margin to match the width of the sidebar */
        }

        header {
            background-color: #ffffff;
            color: #000000;
            padding: 10px;
            text-align: center;
            position: relative;
            z-index: 1; /* Ensure the header stays on top */
            height: 70px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        header{
            text-align: center;
            font-size: xx-large;
            margin-left: 10%;
            font-family: "Poppins", sans-serif;
        }
        .left-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 15.5%;
            background-color: #000000;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            height: 100%; /* Adjust the height as needed */
            z-index: 2; /* Ensure the left section is above the header */
            font-family: "Poppins", sans-serif;
        }

        .logo {
            height: 70px;
            width: auto;
            margin-right: 10px;
            margin-left: 20px;
        }

        .dashboard {
            max-width: 800px;
            margin: 80px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            text-align: center;
            color: #343a40;
        }

        .collapsible-section {
            cursor: pointer;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
        }

        .collapsible-content {
            display: none;
            padding: 10px;
        }

        .booking-entry {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
            padding: 10px;
            background-color: #ffffff;
        }

        button {
            padding: 5px 10px;
            margin-top: 10px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
        }

        .alert {
            margin-top: 10px;
            border-radius: 5px;
        }

        .alert-info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
    </style>
</head>

<body>
    <header id="dashboardHeader">
    </header>
    <div class="left-section">


    <div class="navigation-link-logout-link" onclick="logout()">Logout</div>
    </div>
    <div id="mainContent">
        <div class="dashboard">
            <h2>Salon Dashboard</h2>

            <!-- Pending Bookings Collapsible Section -->
            <div class="collapsible-section" data-toggle="collapse" data-target="#pendingBookingsSection">
                <h3>Pending Bookings</h3>
            </div>
            <div id="pendingBookingsSection" class="collapse">
                <div class="bookings" id="pendingBookings">
                    <!-- Pending booking data will be displayed here -->
                </div>
            </div>

            <!-- Approved Bookings Collapsible Section -->
            <div class="collapsible-section" data-toggle="collapse" data-target="#approvedBookingsSection">
                <h3>Approved Bookings</h3>
            </div>
            <div id="approvedBookingsSection" class="collapse">
                <div class="bookings" id="approvedBookings">
                    <!-- Approved booking data will be displayed here -->
                </div>
            </div>

            <!-- Declined Bookings Collapsible Section -->
            <div class="collapsible-section" data-toggle="collapse" data-target="#declinedBookingsSection">
                <h3>Declined Bookings</h3>
            </div>
            <div id="declinedBookingsSection" class="collapse">
                <div class="bookings" id="declinedBookings">
                    <!-- Declined booking data will be displayed here -->
                </div>
            </div>

            <div id="feedbackMessage"></div>
        </div>
    </div>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyBj1haaSvpv6SHe8PwX5wazT56DahPOKQQ",
            authDomain: "snaplooks-bd932.firebaseapp.com",
            databaseURL: "https://snaplooks-bd932-default-rtdb.firebaseio.com/",
            projectId: "snaplooks-bd932",
            storageBucket: "snaplooks-bd932.appspot.com",
            messagingSenderId: "680311673132",
            appId: "1:680311673132:web:5d55f0b0fe817b8ac39c89"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();

        function displaySalonBookings() {
    var pendingBookingsContainer = document.getElementById('pendingBookings');
    var feedbackMessageContainer = document.getElementById('feedbackMessage');

    // Clear existing content
    pendingBookingsContainer.innerHTML = '';
    feedbackMessageContainer.innerHTML = '';

    // Fetch bookings from the "Salon_bookings" collection with salonId matching the logged-in salon
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            var loggedInSalonId = user.uid;

            db.collection('Salon_bookings')
                .where('salonId', '==', loggedInSalonId)
                .get()
                .then(querySnapshot => {
                    if (!querySnapshot.empty) {
                        querySnapshot.forEach(doc => {
                            var bookingData = doc.data();
                            var bookingHtml = `
                                <div class="booking-entry">
                                    <p>Date: ${bookingData.appointmentDate}</p>
                                    <p>Time: ${bookingData.appointmentTime}</p>
                                    <p>Salon ID: ${bookingData.salonId}</p>
                                    
                                    
                                    <p>Services: ${bookingData.selectedServices}</p>
                                    <p>Total Amount: ${bookingData.totalAmount}</p>
                                    <p>User Email: ${bookingData.email}</p>
                                    <p>User ID: ${bookingData.userId}</p>
                                    <button onclick="confirmApproveBooking('${doc.id}')">Approve</button>
                                    <button onclick="confirmDeclineBooking('${doc.id}')">Decline</button>
                                </div>
                            `;
                            pendingBookingsContainer.appendChild(document.createRange().createContextualFragment(bookingHtml));
                        });
                    } else {
                        // Show a message when there are no bookings
                        feedbackMessageContainer.innerHTML = '<div class="alert alert-info" role="alert">No bookings currently.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching salon bookings:', error);
                    showFeedbackMessage('Error fetching bookings. Please try again.', 'danger');
                });
        } else {
            // Handle the case where the user is not authenticated.
            console.error('User not authenticated.');
            showFeedbackMessage('User not authenticated. Please log in.', 'danger');
        }
    });
}
        // Function to automatically fetch salon ID if using Firebase Authentication
        function getSalonId() {
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            salonId = user.uid;
            console.log('Salon ID:', salonId);

            // Call the function to display pending bookings for the logged-in salon
            displaySalonBookings();
        } else {
            // Handle the case where the user is not authenticated.
            console.error('User not authenticated.');
            showFeedbackMessage('User not authenticated. Please log in.', 'danger');
        }
    });
}

function displayApprovedBookings() {
        var approvedBookingsContainer = document.getElementById('approvedBookings');
        var feedbackMessageContainer = document.getElementById('feedbackMessage');

        // Clear existing content
        approvedBookingsContainer.innerHTML = '';

        // Fetch approved bookings from the "Approved_bookings" collection
        db.collection('Approved_bookings')
            .get()
            .then(querySnapshot => {
                if (!querySnapshot.empty) {
                    querySnapshot.forEach(doc => {
                        var approvedBookingData = doc.data();
                        var approvedBookingHtml = `
                            <div class="booking-entry">
                                <p>Date: ${approvedBookingData.appointmentDate}</p>
                                    <p>Time: ${approvedBookingData.appointmentTime}</p>
                                    <p>Salon ID: ${approvedBookingData.salonId}</p
                                    <p>Services: ${approvedBookingData.selectedServices}</p>
                                    <p>Total Amount: ${approvedBookingData.totalAmount}</p>
                                    <p>User Email: ${approvedBookingData.email}</p>
                                    <p>User ID: ${approvedBookingData.userId}</p>
                                <button onclick="confirmCancelBooking('${doc.id}')">Cancel Booking</button>
                                <button onclick="confirmCompleteBooking('${doc.id}')">Booking Completed</button>
                            </div>
                        `;
                        approvedBookingsContainer.appendChild(document.createRange().createContextualFragment(approvedBookingHtml));
                    });
                } else {
                    // Show a message when there are no approved bookings
                    feedbackMessageContainer.innerHTML = '<div class="alert alert-info" role="alert">No approved bookings currently.</div>';
                }
            })
            .catch(error => {
                console.error('Error fetching approved bookings:', error);
                showFeedbackMessage('Error fetching approved bookings. Please try again.', 'danger');
            });
    }
        // Function to confirm before canceling a booking
        function confirmCancelBooking(bookingId) {
            if (window.confirm('Are you sure you want to cancel this booking?')) {
                cancelBooking(bookingId);
            }
        }

        // Function to cancel a booking
        function cancelBooking(bookingId) {
            // Get the reference to the booking document in "Approved_bookings" collection
            var bookingRef = db.collection('Approved_bookings').doc(bookingId);

            // Get the data of the booking to be moved
            bookingRef.get()
                .then(doc => {
                    if (doc.exists) {
                        var bookingData = doc.data();

                        // Add the booking data to "Declined_bookings" collection
                        return db.collection('Declined_bookings').add(bookingData);
                    } else {
                        // Handle the case where the booking document does not exist
                        console.error('Booking document does not exist.');
                        showFeedbackMessage('Error canceling booking. Please try again.', 'danger');
                    }
                })
                .then(() => {
                    // After successfully adding to "Declined_bookings," delete from "Approved_bookings"
                    return bookingRef.delete();
                })
                .then(() => {
                    // Update the displayed bookings on the salon dashboard
                    displayApprovedBookings();
                    showFeedbackMessage('Booking canceled successfully!', 'success');
                })
                .catch(error => {
                    console.error('Error canceling booking:', error);
                    showFeedbackMessage('Error canceling booking. Please try again.', 'danger');
                });
        }


        // Function to confirm before marking a booking as completed
function confirmCompleteBooking(bookingId) {
    if (window.confirm('Is this booking completed?')) {
        completeBooking(bookingId);
    }
}

// Function to mark a booking as completed
// Inside the completeBooking function
function completeBooking(bookingId) {
    // Get the reference to the booking document in "Approved_bookings" collection
    var bookingRef = db.collection('Approved_bookings').doc(bookingId);
    var bookingData;  // Declare bookingData variable

    // Get the data of the booking to be moved
    bookingRef.get()
        .then(doc => {
            if (doc.exists) {
                bookingData = doc.data();  // Assign value to bookingData
                // Add the booking data to "Booking_Completed" collection
                return db.collection('Booking_Completed').add(bookingData);
            } else {
                // Handle the case where the booking document does not exist
                console.error('Booking document does not exist.');
                showFeedbackMessage('Error completing booking. Please try again.', 'danger');
            }
        })
        .then(() => {
            // After successfully adding to "Booking_Completed," delete from "Approved_bookings"
            return bookingRef.delete();
        })
        .then(() => {
            // Update the displayed bookings on the salon dashboard
            displayApprovedBookings();
            showFeedbackMessage('Booking marked as completed successfully!', 'success');

            // Send the review link after marking the booking as completed
            sendReviewLink(bookingData.email);  // Pass bookingData to sendReviewLink
        })
        .catch(error => {
            console.error('Error marking booking as completed:', error);
            showFeedbackMessage('Error marking booking as completed. Please try again.', 'danger');
        });
}

// Add this function to your script
function sendReviewLink(userEmail) {
    // You can use fetch or any other AJAX method to send a request to your server
    fetch('/send-review-link', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            userEmail: userEmail,
        }),
    })
    .then(response => response.json())
    .then(data => {
        // Handle the response, you can display a message to the user
        console.log(data);
        if (data.success) {
            alert('Review link sent successfully!');
        } else {
            alert('Failed to send review link.');
        }
    })
    .catch(error => {
        console.error('Error sending review link:', error);
        alert('Error sending review link. Please try again.');
    });
}
        // Call this function to display approved bookings on salon dashboard
        displayApprovedBookings();

function displayDeclinedBookings() {
    var declinedBookingsContainer = document.getElementById('declinedBookings');
    var feedbackMessageContainer = document.getElementById('feedbackMessage');

    // Clear existing content
    declinedBookingsContainer.innerHTML = '';

    // Fetch declined bookings from the "Declined_bookings" collection
    db.collection('Declined_bookings')
        .get()
        .then(querySnapshot => {
            if (!querySnapshot.empty) {
                querySnapshot.forEach(doc => {
                    var declinedBookingData = doc.data();
                    var declinedBookingHtml = `
                        <div class="booking-entry">
                            <p>Date: ${declinedBookingData.appointmentDate}</p>
                            <p>Time: ${declinedBookingData.appointmentTime}</p>
                            <p>Salon ID: ${declinedBookingData.salonId}</p>
                            <p>Salon Name: ${declinedBookingData.salonName}</p>
                            <p>Services: ${declinedBookingData.services ? declinedBookingData.services.map(service => service.service).join(', ') : 'N/A'}</p>

                            <p>Total Amount: ${declinedBookingData.totalAmount}</p>
                            <p>User Email: ${declinedBookingData.userEmail}</p>
                            <p>User ID: ${declinedBookingData.userId}</p>
                        </div>
                    `;
                    declinedBookingsContainer.appendChild(document.createRange().createContextualFragment(declinedBookingHtml));
                });

                // Add "Clear Declined Bookings" button
                var clearButtonHtml = '<button onclick="clearDeclinedBookings()">Clear Declined Bookings</button>';
                declinedBookingsContainer.appendChild(document.createRange().createContextualFragment(clearButtonHtml));
            } else {
                // Show a message when there are no declined bookings
                feedbackMessageContainer.innerHTML = '<div class="alert alert-info" role="alert">No declined bookings currently.</div>';
            }
        })
        .catch(error => {
            console.error('Error fetching declined bookings:', error);
            showFeedbackMessage('Error fetching declined bookings. Please try again.', 'danger');
        });
}

// Function to clear declined bookings
function clearDeclinedBookings() {
    // Add logic to clear the declined bookings collection
    db.collection('Declined_bookings')
        .get()
        .then(querySnapshot => {
            querySnapshot.forEach(doc => {
                // Delete each document in the collection
                db.collection('Declined_bookings').doc(doc.id).delete();
            });

            // After clearing, refresh the displayed declined bookings
            displayDeclinedBookings();
            showFeedbackMessage('Cleared declined bookings successfully!', 'success');
        })
        .catch(error => {
            console.error('Error clearing declined bookings:', error);
            showFeedbackMessage('Error clearing declined bookings. Please try again.', 'danger');
        });
}

        // Call this function to display declined bookings on salon dashboard
        displayDeclinedBookings();

        // Function to confirm before approving a booking
        function confirmApproveBooking(bookingId) {
            if (window.confirm('Are you sure you want to approve this booking?')) {
                approveBooking(bookingId);
            }
        }

        // Function to confirm before declining a booking
        function confirmDeclineBooking(bookingId) {
            if (window.confirm('Are you sure you want to decline this booking?')) {
                declineBooking(bookingId);
            }
        }

        // Function to approve a booking
function approveBooking(bookingId) {
    // Get the reference to the booking document in "Salon_bookings" collection
    var bookingRef = db.collection('Salon_bookings').doc(bookingId);

    // Get the data of the booking to be moved
    bookingRef.get()
        .then(doc => {
            if (doc.exists) {
                var bookingData = doc.data();

                // Add the booking data to "Approved_bookings" collection
                return db.collection('Approved_bookings').add(bookingData);
            } else {
                // Handle the case where the booking document does not exist
                console.error('Booking document does not exist.');
                showFeedbackMessage('Error approving booking. Please try again.', 'danger');
            }
        })
        .then(() => {
            // After successfully adding to "Approved_bookings," delete from "Salon_bookings"
            return bookingRef.delete();
        })
        .then(() => {
            // Update the displayed bookings on the salon dashboard
            displaySalonBookings();
            showFeedbackMessage('Booking approved successfully!', 'success');
        })
        .catch(error => {
            console.error('Error approving booking:', error);
            showFeedbackMessage('Error approving booking. Please try again.', 'danger');
        });
}

// Function to decline a booking
function declineBooking(bookingId) {
    // Get the reference to the booking document in "Salon_bookings" collection
    var bookingRef = db.collection('Salon_bookings').doc(bookingId);

    // Get the data of the booking to be moved
    bookingRef.get()
        .then(doc => {
            if (doc.exists) {
                var bookingData = doc.data();

                // Add the booking data to "Declined_bookings" collection
                return db.collection('Declined_bookings').add(bookingData);
            } else {
                // Handle the case where the booking document does not exist
                console.error('Booking document does not exist.');
                showFeedbackMessage('Error declining booking. Please try again.', 'danger');
            }
        })
        .then(() => {
            // After successfully adding to "Declined_bookings," delete from "Salon_bookings"
            return bookingRef.delete();
        })
        .then(() => {
            // Update the displayed bookings on the salon dashboard
            displaySalonBookings();
            showFeedbackMessage('Booking declined successfully!', 'success');
        })
        .catch(error => {
            console.error('Error declining booking:', error);
            showFeedbackMessage('Error declining booking. Please try again.', 'danger');
        });
}
        function showFeedbackMessage(message, type) {
            var feedbackMessageContainer = document.getElementById('feedbackMessage');
            feedbackMessageContainer.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
        }

        // Call this function to display pending bookings on salon dashboard
        getSalonId();
    </script>
</body>

</html>
